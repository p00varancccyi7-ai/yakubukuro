<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>薬袋QR照合システム</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #status { margin-top: 20px; font-size: 1.2em; }
    #reader { width: 300px; height: 300px; margin-top: 20px; border: 1px solid #ccc; }
    button { font-size: 1em; padding: 10px 20px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>薬袋QR照合システム</h1>
  <button id="scan">QRコードを読み取る</button>
  <div id="status">薬袋QRを読み取ってください</div>
  <div id="reader"></div>

  <!-- HTML5 QR Codeライブラリ -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <script>
    let session = { drugQR: null, userQR: null };

    // QRコードIDに対応する名前
    const nameMap = {
      "drug1": "福岡太郎",
      "user1": "福岡太郎",
      "drug2": "大分二郎",
      "user2": "大分二郎",
      "drug3": "佐賀花子",
      "user3": "佐賀花子"
    };

    const speak = (text) => {
      const utterance = new SpeechSynthesisUtterance(text);
      speechSynthesis.speak(utterance);
    };

    const html5QrCode = new Html5Qrcode("reader");

    document.getElementById("scan").addEventListener("click", () => {
      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          const cameraId = cameras[0].id;
          html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            qrCodeMessage => {
              const id = qrCodeMessage.trim();
              const name = nameMap[id];

              if (!name) {
                speak("不明なQRコードです");
                document.getElementById("status").innerText = "不明なQRコードです";
                return;
              }

              if (id.startsWith("drug")) {
                session.drugQR = id;
                speak(`${name}さんのお薬です。本人QRを読んでください`);
                document.getElementById("status").innerText = `薬袋QRを読み取りました: ${name}さん`;
              } else if (id.startsWith("user")) {
                session.userQR = id;
                if (!session.drugQR) {
                  speak("先に薬袋QRを読んでください");
                  document.getElementById("status").innerText = "薬袋QRを先に読み取ってください";
                  session.userQR = null;
                  return;
                }

                const drugName = nameMap[session.drugQR];
                const userName = nameMap[session.userQR];

                if (drugName === userName) {
                  speak(`${userName}さん、正しい利用者です`);
                  document.getElementById("status").innerText = `${userName}さん、正しい利用者です`;
                } else {
                  speak("違います！薬を戻してください！");
                  document.getElementById("status").innerText = `照合失敗！薬を戻してください`;
                }

                session = { drugQR: null, userQR: null };
              }
            },
            errorMessage => {
              console.warn("QR読み取りエラー:", errorMessage);
            }
          ).catch(err => {
            alert("カメラ起動に失敗しました: " + err);
          });
        } else {
          alert("カメラが見つかりません");
        }
      }).catch(err => {
        alert("カメラが取得できません: " + err);
      });
    });
  </script>
</body>
</html>
